name: PR source branch name guardrail

on:
  pull_request:

jobs:
  require-canonical-branch-name:
    runs-on: ubuntu-latest
    steps:
      - name: Validate source branch naming
        env:
          HEAD_REF: ${{ github.event.pull_request.head.ref }}
        run: |
          set -euo pipefail

          if [[ -z "${HEAD_REF}" ]]; then
            echo "::error::Could not determine source branch name."
            exit 1
          fi

          if [[ "${HEAD_REF}" == "main" ]]; then
            echo "Branch guardrail: source branch is main; no check needed."
            exit 0
          fi

          if echo "${HEAD_REF}" | grep -Eq '^codex/E[0-9]+-F[0-9]+-S[0-9]+-.+'; then
            echo "Branch guardrail: canonical branch pattern validated (${HEAD_REF})."
            exit 0
          fi

          echo "::error::Pull request source branch must be named like 'codex/E#-F#-S#-<slug>' (for example: codex/E1-F1-S1-contracts-trace-envelope)."
          echo "Current source branch: ${HEAD_REF}"
          exit 1
